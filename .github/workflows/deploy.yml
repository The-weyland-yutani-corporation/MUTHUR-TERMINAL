name: Deploy to Azure Container Apps

# ── Trigger ──
# Staging:    push to 'staging' branch
# Production: push to 'main' branch
# Manual:     workflow_dispatch with environment selector
on:
  push:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production

# ── Prerequisites (one-time Azure CLI setup, repeat per environment) ──
#
# 1. Create Azure resources per environment:
#      az group create --name <RG_NAME> --location eastus
#      az acr create --name <ACR_NAME> --resource-group <RG_NAME> --sku Basic --admin-enabled true
#      az containerapp env create --name <ENV_NAME> --resource-group <RG_NAME> --location eastus
#      az containerapp create --name <APP_NAME> --resource-group <RG_NAME> \
#        --environment <ENV_NAME> --image <ACR_NAME>.azurecr.io/muthur-terminal:latest \
#        --target-port 3000 --ingress external
#      az containerapp secret set --name <APP_NAME> --resource-group <RG_NAME> \
#        --secrets github-token=<YOUR_FINE_GRAINED_PAT>
#
# 2. Create Azure AD app + federated credentials (one per branch):
#      az ad app create --display-name "muthur-github-actions"
#      az ad sp create --id <APP_ID>
#      az role assignment create --assignee <APP_ID> --role contributor \
#        --scope /subscriptions/<SUB_ID>/resourceGroups/<RG_NAME>
#      # Staging credential (branch-based subject)
#      az ad app federated-credential create --id <APP_ID> --parameters \
#        '{"name":"github-staging","issuer":"https://token.actions.githubusercontent.com",
#          "subject":"repo:<OWNER>/MUTHUR-TERMINAL:ref:refs/heads/staging",
#          "audiences":["api://AzureADTokenExchange"]}'
#      # Production credential (branch-based subject)
#      az ad app federated-credential create --id <APP_ID> --parameters \
#        '{"name":"github-production","issuer":"https://token.actions.githubusercontent.com",
#          "subject":"repo:<OWNER>/MUTHUR-TERMINAL:ref:refs/heads/main",
#          "audiences":["api://AzureADTokenExchange"]}'
#
# 3. Add GitHub repo variables (Settings > Variables > Repository variables):
#      AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID

env:
  IMAGE_NAME: muthur-terminal

jobs:
  # ── Job 1: Determine target environment and resolve resource names ──
  resolve-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set.outputs.environment }}
      container_app_name: ${{ steps.set.outputs.container_app_name }}
      resource_group: ${{ steps.set.outputs.resource_group }}
      container_registry: ${{ steps.set.outputs.container_registry }}
    steps:
      - name: Resolve environment from trigger
        id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENV="staging"
          else
            echo "::error::Unsupported branch for deployment"
            exit 1
          fi
          echo "environment=$ENV" >> "$GITHUB_OUTPUT"

          if [ "$ENV" = "production" ]; then
            echo "container_app_name=muthur-terminal" >> "$GITHUB_OUTPUT"
            echo "resource_group=muthur-rg" >> "$GITHUB_OUTPUT"
            echo "container_registry=muthurterminal" >> "$GITHUB_OUTPUT"
          else
            echo "container_app_name=muthur-terminal-staging" >> "$GITHUB_OUTPUT"
            echo "resource_group=muthur-rg-staging" >> "$GITHUB_OUTPUT"
            echo "container_registry=muthurterminal" >> "$GITHUB_OUTPUT"
          fi

  # ── Job 2: Build & Deploy ──
  build-and-deploy:
    needs: resolve-env
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ needs.resolve-env.outputs.container_registry }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ needs.resolve-env.outputs.container_registry }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ needs.resolve-env.outputs.container_registry }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ needs.resolve-env.outputs.resource_group }}
          containerAppName: ${{ needs.resolve-env.outputs.container_app_name }}
          imageToDeploy: ${{ needs.resolve-env.outputs.container_registry }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          environmentVariables: >-
            GITHUB_TOKEN=secretref:github-token
